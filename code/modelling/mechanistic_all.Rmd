---
title: "analyze the decay parameters"
output: html_notebook
---

```{r}
library(parallel)
library(optimx)
library(GGally)
```

```{r }
citation(package = "optimx")
```

```{r}
list.of.cells <- read_csv("~/plots/all_data/all_exp_data.csv") %>% split(.$cell.id)
```

```{r}
#for non treated (no DMSO cells)cells all the three GFPs
bind_rows(list.of.cells) %>% 
  filter( treatment == "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = gfpMeanBgAFsub , group_by = cell.id ))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_wrap(~degron, scales = "free")+
  theme_pubr()

bind_rows(list.of.cells) %>% 
  filter( treatment != "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = gfpMeanBgAFsub , group_by = cell.id ))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_wrap(~treatment, scales = "free")+
  theme_pubr()
```


#profiles
```{r}
#for non treated cells all the three GFPs
bind_rows(list.of.cells) %>% 
  filter( treatment %in% c("none","dmso1","dmso2")) %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = It_I0 , group_by = cell.id , color = treatment))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_grid(red~degron, scales = "free_x")+
  scale_y_log10()+
  theme_pubr()

#for non treated (no DMSO cells)cells all the three GFPs
bind_rows(list.of.cells) %>% 
  filter( treatment == "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = It_I0 , group_by = cell.id , color = red))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_wrap(~degron, scales = "free_x")+
  scale_y_log10()+
  theme_pubr()

#CLN2
bind_rows(list.of.cells) %>% 
  filter(degron %in% c("cln2.3"), treatment == "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = log(It_I0) , group_by = cell.id))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_grid(degron~red, scales = "free_x")+
  theme_pubr()

#mODC
bind_rows(list.of.cells) %>% 
  filter(degron %in% c("mODC.2"), treatment == "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = log(It_I0) , group_by = cell.id))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_grid(degron~red, scales = "free_x")+
  theme_pubr()

#stable
bind_rows(list.of.cells) %>% 
  filter(degron == "stable.2", treatment == "none", red == "pup1-rfp") %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = It_I0 , group_by = cell.id))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_wrap(~red, scales = "free_x")+
  scale_y_log10()+
  theme_pubr()

bind_rows(list.of.cells) %>% 
  filter(treatment != "none" | degron %in% c("stable.2","stable.3")) %>% 
  group_by(cell.id) %>% 
  mutate(It_I0 = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  ggplot(.,aes(x = delta.time/60, y = It_I0 , group_by = cell.id))+
  geom_line(alpha = 0.2)+
  geom_hline(yintercept = 0.5)+
  facet_wrap(~treatment, scales = "free_x")+
  scale_y_log10()+
  theme_pubr()
```

```{r}
#CLN2
bind_rows(list.of.cells) %>% 
  filter(degron %in% c("cln2","cln2.2","cln2.3"), treatment == "none", delta.time == 0) %>% 
  ggplot(.,aes(x = gfpMeanBgAFsub, fill = degron))+
  geom_density(aes(y = ..scaled..), alpha = 0.2)+
  facet_wrap(~red, scales = "free_x")+
  scale_x_log10()+
  theme_pubr()

#mODC
bind_rows(list.of.cells) %>% 
  filter(degron %in% c("mODC","mODC.2","mODC.3"), treatment == "none", delta.time == 0) %>% 
   ggplot(.,aes(x = gfpMeanBgAFsub, fill = degron))+
  geom_density(aes(y = ..scaled..), alpha = 0.2)+
  facet_wrap(~red, scales = "free_x")+
  scale_x_log10()+
  theme_pubr()
```

```{r}
bind_rows(list.of.cells) %>% 
  filter(image.no == 1) %>% 
  group_by(treatment, red, degron) %>% tally()
```


#mechanistic models with maturation, decay and f

```{r}
#with 3 parameters (rate of decay, rate of maturation, frac of translation after CHX treatment)
 mechanistic.fn<- function(par, df){
   f <- par[1]
   dy <- par[2]
   dm <- par[3]

   df.new <- df  %>%
     mutate(model = ((dy * (1 - f) * exp(-dy * delta.time)) / dm) + exp(-dy * delta.time) +
              (1 - exp(-dy * delta.time)) * f -
              ((dy * (1 - f) * exp(-(dy + dm) * delta.time)) / dm)) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
  }

#two parameter model (rate of decay, frac of translation after CHX treatment)
 mechanistic.fn.nodm<- function(par, df){
   f <- par[1]
   dy <- par[2]

   df.new <- df  %>%
     mutate(model = exp(-dy * delta.time) +(1 - exp(-dy * delta.time)) * f ) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
 }
 
#one parameter model (rate of decay, exponential model)
  mechanistic.fn.exp<- function(par, df){
   
   dy <- par[1]

   df.new <- df  %>%
     mutate(model = exp(-dy * delta.time)) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
  }
  
#two parameter model (rate of maturation and rate of decay)
    mechanistic.fn.wof<- function(par, df){
  
   dy <- par[1]
   dm <- par[2]

   df.new <- df  %>%
     mutate(model = ((dy  * exp(-dy * delta.time)) / dm) + exp(-dy * delta.time)  -
              ((dy * 1 * exp(-(dy + dm) * delta.time)) / dm)) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
    }
    
#1 parameter model with a constant maturation rate: 
 mechanistic.fn.wof.cntDM<- function(par, df){
  
   dy <- par[1]
   dm <- ((0.28+0.18 +1.2)/3 *10^-3)*60

   df.new <- df  %>%
     mutate(model = ((dy  * exp(-dy * delta.time)) / dm) + exp(-dy * delta.time)  -
              ((dy * 1 * exp(-(dy + dm) * delta.time)) / dm)) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
    }
```

(dy*(1-frac)*EXP(-dy*A1)/dm + EXP(-dy*A1) + (1-EXP(-dy*A1))*frac - dy*(1-frac)*EXP(-(dy+dm)*A1)/dm)

```{r}
log(2)/6 #for sfGFP in yeast growth conditions 
```

```{r}
#degron GFPS
list.of.cells.1 <- bind_rows(list.of.cells) %>% #to analyze the new experiments from 7-20-22 and 8-4-22
  filter(degron %in% c("mODC.3","cln2.3")) %>% 
  split(.$cell.id)

#only stable and 50uM treatment cells
list.of.cells.2 <- bind_rows(list.of.cells) %>% #to analyze the stable pup1-rfp from 7-20-22
  filter(degron %in% c("stable", "stable.2") |
         treatment == "50uM") %>% 
  split(.$cell.id)

```

10-18-22
```{r}
#degron GFPS
list.of.cells.1 <- bind_rows(list.of.cells) %>% #to analyze the new experiments from 7-20-22 and 8-4-22
  filter(degron == "cln2.4") %>% 
  split(.$cell.id)

#only stable and 50uM treatment cells
list.of.cells.2 <- bind_rows(list.of.cells) %>% #to analyze the stable pup1-rfp from 7-20-22
  filter(degron == "stable.3") %>% 
  split(.$cell.id)
```

#estimating parameters 
dy, dm , f
```{r}
#for the degron GFP

#10-18-22 for the repeate of cln2 
single.cell.dy.f.dm <- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.5, 0.05005, 0.1)
   
   names(par.optim) <- c("f", "dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn , 
          method = "L-BFGS-B", 
          lower = c(0, 0.005, 0.00001), # dy = 0.00001*60 for stable GFP
          upper = c(1, 1, Inf), #changed from dy = 6 to dy = 10 and now to dy = 1
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```



```{r}
#for the stable GFP and the 50uM treatment
#for the repeate of 10-7-22 
single.cell.dy.f.dm.2 <- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.5, 0.005005, 0.1)
   
   names(par.optim) <- c("f", "dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn , 
          method = "L-BFGS-B", 
          lower = c(0, 0.0005, 0.00001), # dy = 0.00001*60 for stable GFP
          upper = c(1, 0.1, Inf), #change dy = 0.1 from 10, similarly for all the other optimizations 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```


```{r}
single.cell.dy.f.dm.df <- single.cell.dy.f.dm %>% bind_rows(.id = "cell.id")
single.cell.dy.f.dm.df.2 <- single.cell.dy.f.dm.2 %>% bind_rows(.id = "cell.id")

```

```{r}
converged.cells <- bind_rows(single.cell.dy.f.dm.df,
                             single.cell.dy.f.dm.df.2)  %>%
  filter(convcode == 0) %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6])

# converged.cells <- single.cell.dy.f.dm.df.2  %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])
```

```{r}
# converged.cells.old <- single.cell.dy.f.dm.df  %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])
```

##plots
```{r}
#dis of f
converged.cells %>% 
  ggplot(.,aes(x = f, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

#dm
converged.cells %>% 
  ggplot(.,aes(x = dm, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()

#dy
converged.cells %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
#dy
# converged.cells.old %>% 
#   ggplot(.,aes(x = dy, color = treatment))+
#   geom_density(aes(y = ..scaled..))+
#   facet_grid(red~degron)+
#   scale_x_log10()

#half lives
converged.cells %>% 
  ggplot(.,aes(x = log(2)/dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

#maturation times
converged.cells %>% 
  filter(treatment == "none") %>% 
  ggplot(.,aes(x = log(2)/dm, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()

#RSS
converged.cells %>% 
  ggplot(.,aes(x = value, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
```

##Average values of the parameters
```{r}
converged.cells %>% 
  group_by(treatment, red, degron) %>% 
  summarise(dm.avg = mean(dm))

converged.cells %>% 
  group_by(treatment, red, degron) %>% 
  summarise(f.avg = mean(f),
            dy.avg = mean(dy))
```

#without dm just dy and f
```{r}
#for the degron GFP
single.cell.dy.f.1 <- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.5, 0.05005)
   
   names(par.optim) <- c("f", "dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.nodm , 
          method = "L-BFGS-B", 
          lower = c(0, 0.005), 
          upper = c(1, 1), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)

#for the stable GFP and the 50uM treatment 
single.cell.dy.f.2<- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.5, 0.005005)
   
   names(par.optim) <- c("f", "dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.nodm , 
          method = "L-BFGS-B", 
          lower = c(0, 0.0005), 
          upper = c(1, 0.1), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```

```{r}
single.cell.dy.f.df.1 <- single.cell.dy.f.1 %>% 
  bind_rows(.id = "cell.id")

single.cell.dy.f.df.2 <- single.cell.dy.f.2 %>% 
  bind_rows(.id = "cell.id")
```

```{r}
converged.cells.2 <- bind_rows(single.cell.dy.f.df.1,
                               single.cell.dy.f.df.2) %>%
  filter(convcode == 0) %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6])

# converged.cells.2 <- single.cell.dy.f.df.2 %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])



# 
# converged.cells.2.old <- single.cell.dy.f.df %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])
```

##plots
```{r}
#f
converged.cells.2 %>% 
  ggplot(.,aes(x = f, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

converged.cells.2.old %>% 
  ggplot(.,aes(x = f, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

#dy
converged.cells.2 %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
#dy
converged.cells.2.old %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()

#half lives
converged.cells.2 %>% 
  ggplot(.,aes(x = log(2)/dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

#rss
converged.cells.2 %>% 
  ggplot(.,aes(x = value, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
```

#exponential
```{r}
#for degron GFPs
single.cell.dy.1<- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.05005)
   
   names(par.optim) <- c("dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.exp , 
          method = "L-BFGS-B", 
          lower = c(0.005), 
          upper = c(1), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)

#for stable gfp and 50uM 
single.cell.dy.2 <- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.005005)
   
   names(par.optim) <- c("dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.exp , 
          method = "L-BFGS-B", 
          lower = c(0.0005), 
          upper = c(0.1), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```

```{r}
single.cell.dy.df.1 <- single.cell.dy.1 %>% 
  bind_rows(.id = "cell.id")

single.cell.dy.df.2 <- single.cell.dy.2 %>% 
  bind_rows(.id = "cell.id")
```


```{r}
converged.cells.3 <- bind_rows(single.cell.dy.df.1,
                               single.cell.dy.df.2) %>%
  filter(convcode == 0) %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6])

# converged.cells.3 <- single.cell.dy.df.2 %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])
# 
# converged.cells.3.old <- single.cell.dy.df %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])

```

##plots
```{r}
#dy
converged.cells.3 %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10() +
  theme(axis.text.x  = element_text(angle = 45))

converged.cells.3.old %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()+
  theme(axis.text.x  = element_text(angle = 45))

#half lives
converged.cells.3 %>% 
  ggplot(.,aes(x = log(2)/dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)

#rss
converged.cells.3 %>% 
  ggplot(.,aes(x = value, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
```

#without f
just dm and dy
```{r}
single.cell.dy.dm.1 <- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.05005, 0.1)
   
   names(par.optim) <- c("dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.wof, 
          method = "L-BFGS-B", 
          lower = c( 0.005, 0.00001), 
          upper = c( 1, Inf), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)

#stable gfp
single.cell.dy.dm.2 <- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.005, 0.1)
   
   names(par.optim) <- c("dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, #updated this line to match the initial db with exp.field when I am optimizing in a loop
          fn = mechanistic.fn.wof, 
          method = "L-BFGS-B", 
          lower = c( 0.0005, 0.00001), 
          upper = c( 0.1, Inf), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```

```{r}
single.cell.dy.dm.df.1 <- single.cell.dy.dm.1 %>% bind_rows(.id = "cell.id")
single.cell.dy.dm.df.2 <- single.cell.dy.dm.2 %>% bind_rows(.id = "cell.id")
```

```{r}
# converged.cells.4.old <- single.cell.dy.dm.df %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])

converged.cells.4 <- bind_rows(single.cell.dy.dm.df.1,
                               single.cell.dy.dm.df.2) %>%
  filter(convcode == 0) %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6])


# converged.cells.4 <- single.cell.dy.dm.df.2 %>% 
#   filter(convcode == 0) %>% 
#   mutate(degron = str_split(cell.id, "_", simplify = T)[,4], 
#          red = str_split(cell.id, "_", simplify = T)[,5],
#          treatment = str_split(cell.id, "_", simplify = T)[,6])


```

#without f and constant dm 
5/9/2023
```{r}
#degron GFPS
list.of.cells.1 <- bind_rows(list.of.cells) %>% 
  filter(degron %in% c("mODC","mODC.2","cln2.2","cln2.3","cln2.4","cln2") & !(treatment %in% c("50uM","5uM","2.5uM","1uM"))) %>% 
  split(.$cell.id)

#only stable and 50uM treatment cells
list.of.cells.2 <- bind_rows(list.of.cells) %>% #to analyze the stable pup1-rfp from 7-20-22
  filter(degron %in% c("stable", "stable.2","stable.3") |
         treatment %in%c("5uM","2.5uM","1uM","50uM")) %>% 
  split(.$cell.id)
```

##fitting 
```{r}
single.cell.dy.cnstDM <- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.05005)
   
   names(par.optim) <- c("dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim,
          fn = mechanistic.fn.wof.cntDM, 
          method = "L-BFGS-B", 
          lower = c( 0.005), 
          upper = c( 1), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)

#stable gfp
single.cell.dy.cnstDM.2 <- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.005)
   
   names(par.optim) <- c("dy")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn.wof.cntDM, 
          method = "L-BFGS-B", 
          lower = c( 0.0005), 
          upper = c( 0.5), 
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)

```

```{r}
single.cell.dy.cnstDM.df <- single.cell.dy.cnstDM %>% bind_rows(.id = "cell.id")
single.cell.dy.cnstDM.df.2 <- single.cell.dy.cnstDM.2 %>% bind_rows(.id = "cell.id")
```

```{r}
converged.cells.cnstDM <- bind_rows(single.cell.dy.cnstDM.df,
                               single.cell.dy.cnstDM.df.2) %>%
  filter(convcode == 0) %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6])
```

```{r}
converged.cells.cnstDM %>% 
  filter(degron == "mODC") %>% 
  ggplot(.,aes(x = dy, color = treatment))+
  geom_density(aes(y = ..scaled..))+
  facet_grid(red~degron)+
  scale_x_log10()
```

#AIC
AIC function equation from the paper: McShane et al 2016 : Kinetic analysis of protein degradation reveals age dependent degradation. 

#for a small sample space, you add a correction 2k(K+1)/(n-k-1)
AIC = 2k + n log(RSS/n) + 2k(K+1)/(n-k-1)

n = no. of data points (31)
k = no. of parameters c(1,2,3)
RSS = Residual sum of squares

exp((AICmin − AICi)/2) can be interpreted as being proportional to the probability that the ith model minimizes the (estimated) information loss.
```{r}
aic.fn <- function(df,n){
  
  df <- df %>% 
    mutate(aic = 2*k + n*log(value/n) ) #without the correction for small sample space
  return(df)
}

```

##cmbining datasets
```{r}
all.model.parm <- converged.cells%>% 
  mutate(model = "dy.dm.f") %>% 
  bind_rows(.,converged.cells.2 %>% 
              mutate(model = "dy.f")) %>% 
  bind_rows(.,converged.cells.3 %>% 
              mutate(model = "exponential")) %>% 
  bind_rows(.,converged.cells.4 %>% 
              mutate(model = "dy.dm"))

#with constant dm
#5.9.23 
all.model.parm <- converged.cells.cnstDM %>% mutate(model = "constDM")
```

##adding the k (no. of parameters) value 
```{r}
all.model.parm <- all.model.parm %>% 
  mutate(k = case_when(model == "dy.dm.f" ~ 3,
                       model %in% c("dy.f","dy.dm") ~ 2,
                       model == "exponential" ~ 1))

#for constant dm and no f, 5/9/23
all.model.parm <- all.model.parm %>% mutate(k = 1)
```

```{r}
aic.df <- aic.fn(all.model.parm, n = 31) %>% 
  group_by(cell.id) %>% 
  arrange(cell.id) %>% 
  ungroup()


```


```{r}
aic.df %>% 
  group_by(treatment, red, degron,model) %>% 
  tally()
```


#Saving the data
```{r}
# aic.df %>% 
#   write_csv(.,path = "~/plots/all_data/aic.csv")

#updating the AIC df with the new experiments 
# read_csv("~/plots/all_data/aic.csv") %>% 
#   filter(!(degron %in% c("stable", "stable.2") | treatment == "50uM")) %>% 
#   bind_rows(.,aic.df) %>% 
#   write_csv(.,path = "~/plots/all_data/aic.csv")

#10-18-22
read_csv("~/plots/all_data/aic.csv") %>% 
  bind_rows(.,aic.df %>% mutate(dm = ((0.28+0.18 +1.2)/3 *10^-3)*60)) %>% 
  write_csv(.,path = "~/plots/all_data/aic.csv")



```

```{r}
# all.model.parm %>% 
#   write_csv(.,"~/plots/all_data/model_parms_2.csv")

# all.model.parm2 <- read_csv("~/plots/all_data/model_parms_2.csv") %>% 
#   filter(!(degron %in% c("stable", "stable.2") | treatment == "50uM")) %>% 
#   bind_rows(.,all.model.parm) 
#   
#   
# all.model.parm2 %>% 
#   write_csv(.,"~/plots/all_data/model_parms_2.csv")

#10-18-22
read_csv("~/plots/all_data/model_parms_2.csv") %>% 
  bind_rows(.,all.model.parm) %>% 
  write_csv(.,"~/plots/all_data/model_parms_2.csv")
```


