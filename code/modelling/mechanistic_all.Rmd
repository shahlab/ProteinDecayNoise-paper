---
title: "analyze the decay parameters"
output: html_notebook
---

```{r}
library(parallel)
library(optimx)
library(GGally)
```

#read the timeseries data
```{r}
list.of.cells <- read_csv("all_exp_data.csv") %>% 
  split(.$cell.id)
```

#mechanistic models with maturation, decay and f
```{r}
#with 3 parameters (rate of decay, rate of maturation, frac of translation after CHX treatment)
 mechanistic.fn<- function(par, df){
   f <- par[1]
   dy <- par[2]
   dm <- par[3]

   df.new <- df  %>%
     mutate(model = ((dy * (1 - f) * exp(-dy * delta.time)) / dm) + exp(-dy * delta.time) +
              (1 - exp(-dy * delta.time)) * f -
              ((dy * (1 - f) * exp(-(dy + dm) * delta.time)) / dm)) %>%
     mutate(error = (I0_It - model) ^ 2) %>%
     summarise(sum.error = sum(error))
    
    return(df.new$sum.error)
  }

```

(dy*(1-frac)*EXP(-dy*A1)/dm + EXP(-dy*A1) + (1-EXP(-dy*A1))*frac - dy*(1-frac)*EXP(-(dy+dm)*A1)/dm)



```{r}
#degron GFPS
list.of.cells.1 <- bind_rows(list.of.cells) %>% #to analyze the new experiments from 7-20-22 and 8-4-22
  filter(degron %in% c("mODC.2","cln2.3")) %>% 
  split(.$cell.id)
```


#estimating parameters 
dy, dm , f
```{r}
#for degron GFPs 
list.of.cells.1 <- bind_rows(list.of.cells) %>% 
  filter(treatment == "none") %>% 
  filter(degron %in% c("mODC.2","cln2.3")) %>% 
  split(.$cell.id)

#with Proteasome inhibition treatment
#dmso
list.of.cells.2 <- bind_rows(list.of.cells) %>%
  filter(treatment %in%  c("dmso1", "dmso2")) %>% 
  split(.$cell.id)
  
#1uM, 2.5uM, 5uM, 50 uM
list.of.cells.pi <- bind_rows(list.of.cells) %>%
  filter(!(treatment %in%  c("dmso1", "dmso2", "none"))) %>% 
  split(.$cell.id)
```
#Optimizing the decay model parameters 
for degron GFPs
```{r}
#for the degron GFP
dm.init <-  ((0.28+0.18 +1.2+0.13)/4 *10^-3)*60

single.cell.dy.f.dm <- mclapply(list.of.cells.1, function(a){ 
   
   par.optim <- c(0.05, 0.05005, dm.init) #change the initial dm value from 0.1 to the average of the four rate of maturations. 
   
   names(par.optim) <- c("f", "dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn , 
          method = "L-BFGS-B", 
          lower = c(0, 0.005, 0.00001), # dy = 0.00001*60 for stable GFP
          upper = c(1, 1, Inf), #changed from dy = 6 to dy = 10 and now to dy = 1
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```

#for DMSO control
Note: Changed the upper limit on the leaky translation parrameter (f) to 0.1
```{r}
#dmso control samples
single.cell.dy.f.dm.2 <- mclapply(list.of.cells.2, function(a){ 
   
   par.optim <- c(0.05, 0.05005, dm.init) #change the initial dm value from 0.1 to the average of the four rate of maturations. 
   
   names(par.optim) <- c("f", "dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn , 
          method = "L-BFGS-B", 
          lower = c(0, 0.005, 0.00001), # dy = 0.00001*60 for stable GFP
          upper = c(0.1, 1, Inf), #upper f to 0.1
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)
```

```{r}
#for all the MG132 treated samples 
single.cell.dy.f.dm.pi <- mclapply(list.of.cells.pi, function(a){ 
   
   par.optim <- c(0.05, 0.005005, dm.init)
   
   names(par.optim) <- c("f", "dy", "dm")
   
   df <- a %>% 
            mutate(image.no = image.no-1) %>% 
            group_by(cell.id) %>% 
            mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1],
                   delta.time = delta.time/60) %>% 
     ungroup()
   
   optimx(par = par.optim, 
          fn = mechanistic.fn , 
          method = "L-BFGS-B", 
          lower = c(0, 0.0005, 0.00001), # dy = 0.00001*60 for stable GFP
          upper = c(0.1, 1, Inf), #change dy = 0.1 from 10, similarly for all the other optimizations; upper dy = 1 for the protein inhibition experiments
          df = df,
          itnmax = 100000)
   }, mc.cores = 40)


```

###making dfs
```{r}

single.cell.dy.f.dm.df <- single.cell.dy.f.dm %>% bind_rows(.id = "cell.id")
single.cell.dy.f.dm.df.2 <- single.cell.dy.f.dm.2 %>% bind_rows(.id = "cell.id")
single.cell.dy.f.dm.df.pi <- single.cell.dy.f.dm.pi %>% bind_rows(.id = "cell.id")

```

```{r}
bind_rows(single.cell.dy.f.dm.df,
                             single.cell.dy.f.dm.df.2,
                             single.cell.dy.f.dm.df.pi)  %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6]) %>% 
  filter(red == "pup1-rfp") %>% 
  group_by(degron, treatment, red, convcode) %>% 
  tally()
```
#keeping only converged cells
```{r}
converged.cells <- bind_rows(single.cell.dy.f.dm.df,
                             single.cell.dy.f.dm.df.2,
                             single.cell.dy.f.dm.df.pi)  %>%
  mutate(degron = str_split(cell.id, "_", simplify = T)[,4],
         red = str_split(cell.id, "_", simplify = T)[,5],
         treatment = str_split(cell.id, "_", simplify = T)[,6]) %>% 
  filter(convcode == 0) 

```


#AIC
AIC function equation from the paper: McShane et al 2016 : Kinetic analysis of protein degradation reveals age dependent degradation. 

#for a small sample space, you add a correction 2k(K+1)/(n-k-1)
AIC = 2k + n log(RSS/n) + 2k(K+1)/(n-k-1)

n = no. of data points (31)
k = no. of parameters c(1,2,3)
RSS = Residual sum of squares

exp((AICmin âˆ’ AICi)/2) can be interpreted as being proportional to the probability that the ith model minimizes the (estimated) information loss.
```{r}
aic.fn <- function(df,n){
  
  df <- df %>% 
    mutate(aic = 2*k + n*log(value/n) ) #without the correction for small sample space
  return(df)
}

```

##cmbining datasets
```{r}
all.model.parm <- converged.cells%>% 
  mutate(model = "dy.dm.f") 

```

##adding the k (no. of parameters) value 
```{r}
all.model.parm <- all.model.parm %>% 
  mutate(k = case_when(model == "dy.dm.f" ~ 3,
                       model %in% c("dy.f","dy.dm") ~ 2,
                       model == "exponential" ~ 1))

```

#getting AIC values for each cell
```{r}
aic.df <- aic.fn(all.model.parm, n = 31) %>% 
  group_by(cell.id) %>% 
  arrange(cell.id) %>% 
  ungroup()
```




#Saving the data
```{r}
aic.df %>% 
  write_csv(.,path = "aic.csv")


```



