---
title: "Create a mega dataframe with all the experiments"
output: html_notebook
---

For all the experiments
```{r}
library(optimx)
library(data.table)
library(tidyverse)
library(reshape2)
library(gganimate)
library(ggridges)
library(ggpubr)
library(parallel)
library(deSolve)
library(minpack.lm)
library(broom)

```



###pup1-rfp experiments
```{r}
#####REPEATE ON 6-28-22
#mODC
mODC.gfp.pup1.2 <- read.csv("../generate_dfs/pup1-rfp-gfp-decay/6-28-22-modc-gfp/data/gfp_mODCPest_pup1_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% 
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

#####REPEATE ON 7-20-22
#cln2-gfp
cln2.gfp.pup1.3 <- read.csv("../generate_dfs/pup1-rfp-gfp-decay/7-20-22-cln2-gfp/data/gfp_cln2Pest_pup1_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% 
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

```

#proteasome inhibition
in the 1uM experiment, the fields of view s3 and s4 have blurry images in the last few timepoints. will be removed from analysis further down. 
```{r}

mODC.gfp.pup1.dmso2 <- read.csv("../generate_dfs/proteasome_inhibition/data/4-1-22/DMSO/gfp_mODCPest_DMSO_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% #remove cells from s7 field of view, blurry cells
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

mODC.gfp.pup1.1uM <- read.csv("../generate_dfs/proteasome_inhibition/data/4-1-22/1uM/gfp_mODCPest_1uMMG132_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% 
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

mODC.gfp.pup1.2.5uM <- read.csv("../generate_dfs/proteasome_inhibition/data/4-1-22/2.5uM/gfp_mODCPest_2.5uMMG132_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% 
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

mODC.gfp.pup1.5uM <- read.csv("../generate_dfs/proteasome_inhibition/data/4-1-22/5uM/gfp_mODCPest_5uMMG132_filtered.csv") %>% 
  mutate(exp = str_split(cell.id, pattern = "_" , simplify = TRUE)[,2],
         exp.field = paste0(str_split(cell.id, pattern = "_" , simplify = TRUE)[,2], "_", 
                            str_split(cell.id, pattern = "_" , simplify = TRUE)[,3])) %>% 
  filter(exp == "20min") %>% 
  select(cell.id,
         delta.time,
         gfpMeanBgAFsub, 
         image.no , 
         exp.field) %>% 
  split(.$cell.id)

```


```{r}

pup1.rfp <- bind_rows(mODC.gfp.pup1.2) %>% 
              mutate(degron = "mODC.2") %>% 
  mutate(red = "pup1-rfp") %>% 
  mutate(cell.id = paste0(cell.id ,"_",degron,"_",red)) %>% 
  split(.$cell.id)
  
all.exp.list <- 
          bind_rows(pup1.rfp) %>%              #bind pup1-rfp background
  mutate(treatment = "none") %>% 
  bind_rows(.,
            bind_rows(
              bind_rows(mODC.gfp.pup1.dmso2) %>%             #bind dmso treatment from 4-1-22 
              mutate(treatment = "dmso2"),
                bind_rows(mODC.gfp.pup1.1uM) %>%             #bind 1uM treatment from 4-1-22
                mutate(treatment = "1uM"),
               bind_rows(mODC.gfp.pup1.2.5uM) %>%            #bind 2.5uM treatment from 4-1-22
                mutate(treatment = "2.5uM"), 
              bind_rows(mODC.gfp.pup1.5uM) %>%               #bind 5uM treatment from 4-1-22
                mutate(treatment = "5uM")) %>% 
              mutate(degron = "mODC",
                     red = "pup1-rfp",
                     cell.id = paste0(cell.id ,"_",degron,"_",red))) %>% 
  mutate(cell.id = paste0(cell.id , "_", treatment)) %>% 
  split(.$cell.id)
  
```


#to add the new repeated experiments to the existing dataframe
```{r}
all.exp.list.3 <- bind_rows(cln2.gfp.pup1.3) %>% 
              mutate(degron = "cln2.3", 
                     red = "pup1-rfp",
                     treatment = "none",
                     cell.id = paste0(cell.id ,"_",degron,"_",red,"_",treatment)
                     )  %>% 
  bind_rows(.,bind_rows(all.exp.list)) %>% 
  split(.$cell.id)

```


Here I get the cell ids of cells which have less than 5 timepoints in my dataframe
```{r}
cellsWithLessThan5tps <- bind_rows(all.exp.list.3) %>% 
  group_by(cell.id) %>% 
  tally() %>% 
  filter(n < 5) %>%
  pull(cell.id)
```

#filtering the cells out which have less than 5 tps 
#only looking at the first 20 timepoints
#only pick cellls which have all 31 timepoints

```{r}
cell.in.all31tp <- bind_rows(all.exp.list.3) %>% 
  filter(!(cell.id %in% cellsWithLessThan5tps)) %>% 
  mutate(exp = str_split(exp.field, "_", simplify = T)[,1]) %>% 
  filter(exp == "20min") %>% 
  filter(image.no < 32) %>% 
  group_by(cell.id) %>% 
  tally() %>% 
  filter(n == 31) #fields of view s3 and s4 from the mODC 1uM treatment with MG135 PI will be removed since their last 5-6 images are blurry.


```

Cells which have data in more than 5 timepoints
```{r}
# gfp.filtered.cells <- bind_rows(all.exp.list) %>% 
#   filter(!(cell.id %in% cellsWithLessThan5tps)) %>% 
#   mutate(exp = str_split(exp.field, "_", simplify = T)[,1]) %>% 
#   filter(exp == "20min") %>% 
#   split(.$cell.id)
```

remove cells which have increased gfp intensity in more than 5 timepoints
```{r}
cells.to.remove <- bind_rows(all.exp.list.3) %>%   
  group_by(cell.id) %>% 
  filter(cell.id %in% cell.in.all31tp$cell.id) %>% 
  mutate(rel.change = lead(gfpMeanBgAFsub)/lag(gfpMeanBgAFsub)) %>% 
  filter(rel.change > 1.05) %>% #changed from 1 to 1.05
  tally() %>% 
  filter(n>5) 


```

```{r}
#total no. of cell before all filtering above
no.of.cells <- bind_rows(all.exp.list.3) %>% 
  filter(image.no == 1) %>% 
  group_by(red, degron, treatment, exp.field) %>% 
  tally() %>% 
  rename("n.all" = "n")

#no. of cells with GFP data in all 31 frames
no.of.cells.in.all31tps <- bind_rows(all.exp.list.3) %>% 
  filter(image.no == 1) %>% 
  filter(cell.id %in% cell.in.all31tp$cell.id) %>% 
  group_by(red, degron, treatment, exp.field) %>% 
  tally() %>% 
  rename("n.31tps" = "n")

#no. of cells which have fluctuating GFP intensities in more than 5 frames
no.of.cells.to.remove <-  bind_rows(all.exp.list.3) %>% 
  filter(image.no == 1) %>% 
  filter(cell.id %in% cell.in.all31tp$cell.id) %>% 
  filter(cell.id %in% cells.to.remove$cell.id) %>% 
  group_by(red, degron, treatment, exp.field) %>% 
  tally() %>% 
  rename("n.remove" = "n")

#a summary of cells we began with, cells w. data in 31 frames, cells with fluctuating GFP intensities
no.of.cells %>% 
  left_join(.,no.of.cells.in.all31tps, by = c("treatment","red","degron","exp.field")) %>% 
  left_join(.,no.of.cells.to.remove, by = c("treatment","red","degron","exp.field")) %>% group_by(degron) %>% summarise(sum(n.31tps))


```

cells with data in all 31 timepoints
```{r}
list.of.cells <- all.exp.list.3 %>%  #removed cells with less than 5 tps
  bind_rows() %>% 
  filter(cell.id %in% cell.in.all31tp$cell.id) %>% #keep cells which have more than 15 timepoints
  filter(!(cell.id %in% cells.to.remove$cell.id)) %>% #remove cells which have increased intensity in more                                                          than 5 time points
  split(.$cell.id)
```

#looking at how many cells we have
```{r}
bind_rows(list.of.cells) %>% 
  filter(image.no == 1) %>% 
  group_by(treatment, red, degron) %>% 
  tally()
```

#saaving the DF in the same dir to be used with mechanistic_all.Rmd
```{r}
list.of.cells %>% 
  bind_rows() %>% 
  write_csv(.,path = "all_exp_data.csv")
  
```

