---
title: "Figure S1"
output: 
    html_document: 
    df_print: paged
author: "Sukanya Das"
date: "`r Sys.time()`"
---
## Supplemental figures with section "Estimating single cell proteasomal decay rates" 
```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```


<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>
```{r}
library(ggplot2)
library(latex2exp)
library(tidyverse)
library(ggpubr)
library(patchwork)
```
#### load the data
This loads the dataframe which has estimated parameters for all the experiments. 
The paper contains data from two independent experiments for GFP-CLN2 and yeGFP, and one experiment for GFP-mODC, with three biological replicates in each experiment. 
The downstream code only plots data from the experiments mentioned above, this is reflected in the code line
"filter(degron %in% c("mODC.2","cln2.3","cln2.4","stable.2","stable.3"))"

### AIC values of the 4 scenarios along with the model parameters estimated 
```{r}
aic.df <- read_csv("../../../data/aic.csv")
```

add the replicate info 
```{r}

aic.df <- aic.df %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

aic.df <- aic.df %>% 
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony)) 
  
```

Cellular attributes
```{r}
pup1.cell.attr <- read_csv("../../../data/all_pup1_cell_attr.csv")
```

removing multiple instances of each cell 
```{r}
pup1.cell.attr <- pup1.cell.attr %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

pup1.cell.attr <- pup1.cell.attr %>% 
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony)) 
 
multiple.pup1 <- pup1.cell.attr %>% 
  mutate(dapi.mean.bg.sub.puncta = ifelse(is.na(dapi.mean.bg.sub.puncta), 0, dapi.mean.bg.sub.puncta) , 
         rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0 , rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0) %>% 
  group_by(cell.id) %>% 
  tally() %>% 
  filter(n>1)

pup1.cell.attr <-  pup1.cell.attr %>% 
  group_by(cell.id) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(cell.id %in% multiple.pup1$cell.id , mean(rfp.mean.bg.sub.puncta), rfp.mean.bg.sub.puncta )) %>% 
    distinct(cell.id, .keep_all = TRUE) 
```


#### Generating the final dataframe to be used for the figure
dy estimated using the 1-parameter exponential and 2-parameter with maturation model
We need both the models because we are comparing the rate of decay from both the models
```{r}
dy.pup1 <- aic.df %>% 
  filter(red == "pup1-rfp") %>% 
  filter(ifelse(degron %in% c("stable.2","stable","stabe.3"), dy < 0.1, dy < 0.5)) %>% 
  group_by(cell.id) %>% 
  mutate(dm = ifelse(is.na(dm), Inf, dm)) %>%
  filter( dm > 0.00001) %>% 
  filter(model %in% c("dy.dm","exponential"))
  
```

#### number of cells that converged in both the models
```{r}
dy.pup1 %>% 
  filter(degron %in% c("mODC.2","cln2.3","cln2.4","stable.2","stable.3")) %>% 
  select(cell.id, model, dy, aic,degron) %>% 
  pivot_wider(values_from = c("dy","aic"), names_from = model) %>% 
  na.omit() %>% 
  group_by(degron) %>% 
  tally()

```

#### Final df used to generate the figures
```{r}
figS2.df <- dy.pup1 %>% 
  filter(treatment == "none") %>% 
  left_join(.,pup1.cell.attr %>%
              filter(red == "pup1-rfp", treatment == "none"),
            by = c("cell.id","treatment","degron","red","colony","exp.field")) %>% 
  mutate(dapi.mean.bg.sub.puncta = ifelse(is.na(dapi.mean.bg.sub.puncta), 0, dapi.mean.bg.sub.puncta) , 
         rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0 , rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0) %>% 
  filter(ifelse(degron %in% c("stable.3","stable.2"), dy < 0.1, dy < 0.5))

```

Number of data points for each cell
```{r}
no.of.dp <- read_csv("../../../data/all_exp_data.csv") %>% 
  filter(cell.id %in% figS2.df$cell.id) %>% 
  group_by(cell.id) %>% 
tally()

no.of.dp
```
##### Analysis of the numbers mentioned in paper
Looking at how many cells converged in the mat model and in exponential model
```{r}
#total no. of cells which converged in the the maturation + decay model but not in the exponential model
figS2.df %>% 
  dplyr::select(cell.id, dy, model, degron) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = dy, names_from = model) %>% 
  filter(is.na(exponential)) %>% 
  group_by(degron) %>% 
  tally()

#total no. of cells which converged in the exponential model but not in the maturation + decay model
figS2.df %>% 
  dplyr::select(cell.id, dy, model, degron) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = dy, names_from = model) %>% 
  filter(is.na(dy.dm)) %>% 
  group_by(degron) %>% 
  tally()
```

##### percent of cells with lowest AIC scores in each model
```{r}
figS2.df %>% 
  filter(degron %in% c("mODC.2","cln2.3","cln2.4","stable.2","stable.3")) %>% 
  mutate(degron = case_when(degron %in% c("mODC","mODC.2") ~ "GFP-mODC",
                            degron %in% c("cln2.2","cln2","cln2.3","cln2.4") ~ "GFP-CLN2",
                            degron %in% c("stable","stable.2","stable.3") ~ "GFP")) %>%
  select(cell.id, model, dy, aic,degron) %>% 
  pivot_wider(values_from = c("dy","aic"), names_from = model) %>% 
  na.omit() %>% 
  mutate(best.model = ifelse(aic_exponential < aic_dy.dm, "exp","mat")) %>% 
  group_by(degron,best.model) %>% 
  tally() %>% 
  mutate(per.mod = round((n/sum(n))*100 ,digits = 2))
```

##### underestimation of decay rates by exponential model grouped by 
```{r}
figS2.df %>% 
  dplyr::select(cell.id, dm, dy, model, degron, gfp.mean.bg.af.sub.new) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = c("dy","dm"), names_from = model) %>% 
  mutate(dm.level = ifelse(dm_dy.dm > 1, ">1", "<1"),
    exp.mat.ratio = ((dy_dy.dm - dy_exponential)/dy_dy.dm)*100) %>% 
  filter(!(is.na(exp.mat.ratio)))%>%
  filter(degron %in% c("mODC.2","cln2.3","stable.3","stable.2","cln2.4")) %>% 
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.4") ~ "GFP-CLN2",
                            degron %in% c("mODC.2") ~ "GFP-mODC",
                            degron %in% c("stable.2","stable.3") ~ "GFP"),
         degron = factor(degron, levels = c("GFP-mODC","GFP-CLN2","GFP"))) %>%
  group_by(degron, dm.level) %>% 
  summarise(median(exp.mat.ratio) %>% signif(.,digits = 2), 
            sd(exp.mat.ratio),
            NROW(exp.mat.ratio))
```

#### plots
## Panel A :aic scores
```{r}
aic.score.ptDenPlt <- figS2.df %>% 
  filter(model %in% c("dy.dm","exponential")) %>% 
  filter(degron %in% c("cln2.3","cln2.4","mODC.2","stable.2","stable.3"), treatment == "none", red == "pup1-rfp") %>%
  group_by(cell.id) %>% 
  filter(!(is.na(dy)), 
         ifelse(degron %in% c("stable.3","stable.2"), dy < 0.1, dy <0.2)) %>% 
  dplyr::select(cell.id, degron, dm,dy,aic, model, colony) %>% 
  ungroup() %>% 
  pivot_wider(values_from = c("dy","aic","dm"), names_from = "model")  %>% 
  mutate(dm_dy.dm = ifelse(is.na(dm_dy.dm), Inf, dm_dy.dm),
    dm.level = ifelse(dm_dy.dm > 1, "high", "low")) %>% 
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2") ~ "yeGFP-mODC",
                            degron %in% c("stable.2","stable.3") ~ "yeGFP"),
         degron = factor(degron, levels = c("yeGFP-mODC","yeGFP-CLN2","yeGFP")))%>%
  ggplot(.,aes(y = aic_exponential, x = aic_dy.dm))+
  # geom_hex(bins = 100)+
  ggpointdensity::geom_pointdensity(size = 0.2, adjust = 4)+
  geom_abline(slope = 1, color = "red4", alpha = 0.5)+
  facet_wrap(~degron, scales = "free")+
  theme_pubr()+
  xlim(-350,-100)+
  ylim(-350,-100)+
  # labs(title = "Model comparison per cell:\nAkaike Information Criterion (AIC)")+
  ylab("AIC [Exponential model]")+
  xlab("AIC [2-Parameter model w Maturation]")+
  labs(title = "A")+
  theme(text = element_text(size = 8), #changed to 12 for GRC from 8
        axis.text.x = element_text(angle = 30), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        strip.background = element_blank(),
        legend.key.size = unit(1.5 ,"mm"),
        legend.position = c(0.95,0.2),
        legend.background = element_blank(),
        legend.direction = "vertical",
        legend.title = element_blank())

aic.score.ptDenPlt
```

## Panel B: dy scatterplot
```{r}
dy.models.scatPlt <- figS2.df %>% 
  filter(model %in% c("dy.dm","exponential")) %>% 
  filter(degron %in% c("cln2.3","cln2.4","stable.2","mODC.2","stable.3"), treatment == "none", red == "pup1-rfp") %>%
  group_by(cell.id) %>% 
  filter(!(is.na(dy)), 
         ifelse(degron %in% c("stable.3","stable.2"), dy < 0.1, dy <0.2)) %>% 
  dplyr::select(cell.id, degron, dm,dy,aic, model, colony) %>% 
  ungroup() %>% 
  pivot_wider(values_from = c("dy","aic","dm"), names_from = "model")  %>% 
  mutate(dm_dy.dm = ifelse(is.na(dm_dy.dm), Inf, dm_dy.dm),
    dm.level = ifelse(dm_dy.dm > 1, "high", "low")) %>%
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2") ~ "yeGFP-mODC",
                            degron %in% c("stable.2","stable.3") ~ "yeGFP"),
         degron = factor(degron, levels = c("yeGFP-mODC","yeGFP-CLN2","yeGFP")))%>%
  ggplot(.,aes(y = dy_exponential, x = dy_dy.dm))+
  # geom_hex(bins = 100)+
  ggpointdensity::geom_pointdensity(size = 0.2, adjust = 0.5)+
  geom_abline(slope = 1, color = "red4", alpha = 0.5)+
  facet_wrap(~degron, scales = "free")+
  theme_pubr()+
  ylab(TeX("Exponential model ($\\delta_{exp}$)"))+
  xlab(TeX("2-parameter model w Maturation ($\\delta_{mat}$)"))+
  # labs(title = "Rate of Decay")+
  labs(title = "B")+
  theme(text = element_text(size =8),#changed to 12 for GRC from 8
        axis.text.x = element_text(angle = 30), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        strip.background = element_blank(),
        legend.key.size = unit(1.5,"mm"),
        legend.position = c(0.95,0.2),
        legend.background = element_blank(),
        legend.direction = "vertical",
        legend.title = element_blank())
dy.models.scatPlt
```
## Panel C: % of cell with mat. rate <1 
#### No. of cells with maturation rate > 1 and < 1 
```{r}
figS2.df %>% 
  dplyr::select(cell.id, dm, dy, model, degron, gfp.mean.bg.af.sub.new) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = c("dy","dm"), names_from = model) %>% 
  mutate(dm.level = ifelse(dm_dy.dm > 1, "high", "low"),
    exp.mat.ratio = ((dy_dy.dm - dy_exponential)/dy_dy.dm)*100) %>% 
  filter(!(is.na(exp.mat.ratio)))%>%
  filter(degron %in% c("mODC.2","cln2.3","cln2.4","stable.3","stable.2")) %>% 
  group_by(degron, dm.level) %>% 
  tally()
```
#### Plot
```{r}
dm.per.low.BarPlt <- figS2.df %>% 
  filter(rfp.mean.bg.sub.puncta > 0,
         degron %in% c("mODC.2","cln2.4","cln2.3","stable.2","stable.3")) %>% 
  filter(model == "dy.dm") %>% 
  filter(treatment == "none", red == "pup1-rfp") %>% 
  filter(ifelse(degron %in% c("stable","stable.2","stable.3"), dy < 0.1, dy < 0.5), 
         dm > 0.00001) %>% 
  mutate(dm.level = ifelse(dm > 1, "high", "low"),
    degron = case_when(degron %in% c("mODC","mODC.2") ~ "yeGFP-mODC",
                            degron %in% c("cln2.2","cln2","cln2.3","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("stable","stable.2","stable.3") ~ "yeGFP"), 
         degron = factor(degron, levels = c("yeGFP-mODC","yeGFP-CLN2","yeGFP"))) %>% 
  group_by(degron, dm.level) %>% 
  tally() %>% 
  pivot_wider(values_from = n, names_from = dm.level) %>% 
  mutate(per.low = (low/(low+high))*100 ) %>% 
  ggplot(.,aes(x = degron, y = per.low))+
  geom_col(width = 0.2)+
  theme_pubr()+
  ylab(bquote(atop("% of cells with" , "rate of maturation \u03bc < 1"~ min^{-1})))+
  labs(title = "C")+
  # ylab(TeX("% of cells with rate of maturation $(\\mu) < 1\\ min^{-1}$"))+
  theme(text = element_text(size = 8), #changed to 12 for GRC from 8
        legend.position = c(0.5, 1), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(2 ,"mm"),
         axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        axis.title.x = element_blank())+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 3))
dm.per.low.BarPlt
```

## Panel D:Underestimation of the decay rates 
Decay rates are higher in the maturation model compared to the exponential model
```{r}
#a dummy df to add the no. of cells in each category
df.underEst <- figS2.df %>% 
  filter( treatment == "none", red == "pup1-rfp") %>% 
  dplyr::select(cell.id, dm, dy, model, degron, gfp.mean.bg.af.sub.new) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = c("dy","dm"), names_from = model) %>% 
  mutate(dm.level = ifelse(dm_dy.dm > 1, ">1", "<1"),
    exp.mat.ratio = ((dy_dy.dm - dy_exponential)/dy_dy.dm)*100) %>% 
  filter(!(is.na(exp.mat.ratio)))%>%
  filter(degron %in% c("mODC.2","cln2.4","cln2.3","stable.2","stable.3")) %>% 
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2") ~ "yeGFP-mODC",
                            degron %in% c("stable.2","stable.3") ~ "yeGFP"),
         degron = factor(degron, levels = c("yeGFP-mODC","yeGFP-CLN2","yeGFP"))) %>% 
  group_by(degron, dm.level) %>% 
  summarise(n = NROW(exp.mat.ratio), 
            exp.mat.ratio = min(exp.mat.ratio)-2) #this is for the placement of the total no. of cells to the plot below each boxplot

df.underEst

```
#### Plot
```{r}
#boxplot of the underestimation 
underEst.bx.plt <- figS2.df %>% 
  filter( treatment == "none", red == "pup1-rfp") %>% 
  dplyr::select(cell.id, dm, dy, model, degron, gfp.mean.bg.af.sub.new) %>% 
  dplyr::ungroup() %>% 
  pivot_wider(values_from = c("dy","dm"), names_from = model) %>% 
  mutate(dm.level = ifelse(dm_dy.dm > 1, ">1", "<1"),
    exp.mat.ratio = ((dy_dy.dm - dy_exponential)/dy_dy.dm)*100) %>% 
  filter(!(is.na(exp.mat.ratio)))%>%
  filter(degron %in% c("mODC.2","cln2.3","stable.3","stable.2","cln2.4")) %>% 
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2") ~ "yeGFP-mODC",
                            degron %in% c("stable.2","stable.3") ~ "yeGFP"),
         degron = factor(degron, levels = c("yeGFP-mODC","yeGFP-CLN2","yeGFP")))%>%
  ggplot(.,aes(x = degron, y = exp.mat.ratio,fill = dm.level))+
  geom_boxplot(outlier.size = 0.2, 
               lwd = 0.1)+
  geom_text(data = df.underEst %>% 
              group_by(dm.level), 
            aes(label = paste("n =",n), fill = dm.level),
            position = position_dodge(width = 0.8), size = 2)+ #changed from 2 to 4 for grc
  theme_pubr()+
  # scale_fill_brewer(name = "Replicate", palette = "Set2")+
  ylab(TeX("% underestimation of rate of decay ($\\frac{\\delta_{mat} - \\delta_{exp}}{\\delta_{mat}}$)"))+
  labs(title = "D")+
  theme(axis.title.x = element_blank(), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        text = element_text(size = 8), #changed to 12 for GRC from 8
        legend.background = element_blank(),
        legend.direction = "vertical", 
        legend.position = c(0.9,0.9),
        legend.key.height = unit(3, "mm"))+
        # legend.position = c(factor("GFP-CLN2"), 40))+
  scale_fill_manual(values = c("salmon3","dodgerblue3"), 
                     name = TeX("$\\mu, min^{-1}"))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 3))

underEst.bx.plt
```

## patchwork
```{r fig.width= 5.5, fig.height= 4}
left.sec <- aic.score.plt
mid.sec <- dy.models.den.plt
right.sec <- underEst.bx.plt
figs2.final <- ((aic.score.ptDenPlt/dy.models.scatPlt)|(dm.per.low.BarPlt/underEst.bx.plt))+
  plot_layout(widths = c(0.65,0.35))
# right.sec <- pup1RFP.halfLives

figs2.final
```
#### saving the full figure as pdf and png
```{r}
ggsave(plot = figs2.final, path = "~/plots/paper1/figures/fig_1/supplemental_figs/fig_s2/", filename = "aic_dy_unest.pdf", width = 7, height = 5 )
ggsave(plot = figs2.final, path = "~/plots/paper1/figures/fig_1/supplemental_figs/fig_s2/", filename = "aic_dy_unest.png", width = 7, height = 5 )
```






