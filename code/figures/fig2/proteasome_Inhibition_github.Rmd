---
title: "Proteasome inhibition"
output: 
    html_document: 
    df_print: paged
author: "Sukanya Das"
date: "`r Sys.time()`"
---
## Figures with section "Estimating single cell proteasomal decay rates" 
```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

Libraries to load
```{r}
library(data.table)
library(tidyverse)
library(reshape2)
library(gganimate)
library(ggridges)
library(ggpubr)
library(patchwork)
library(ggplot2)
```


load the gfp timelapse data used for the mechanistic model
```{r}
#dataframe used for estimating the decay rates
all.exp.list <- read_csv("../../../data/all_exp_data.csv")

#the dataframe with converged parameters
aic.df <- read_csv("../../../data/aic.csv")

```

##adding the replicate info 
```{r}
aic.df <- aic.df %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

aic.df <- aic.df %>% 
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony))
  
```

##adding the cellular attributes
```{r}
pup1.cell.attr <- read_csv("../../../data/all_pup1_cell_attr.csv")

pup1.cell.attr <- pup1.cell.attr %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

pup1.cell.attr <- pup1.cell.attr %>% 
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony)) 

#removing the multiple punctas
multiple.pup1 <- pup1.cell.attr %>% 
  mutate(dapi.mean.bg.sub.puncta = ifelse(is.na(dapi.mean.bg.sub.puncta), 0, dapi.mean.bg.sub.puncta) , 
         rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0 , rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0) %>% group_by(cell.id) %>% tally() %>% filter(n>1)

#if a cell has no puncta, then make the rfp mean value of puncta == 0 and then remove those cells 
pup1.cell.attr <-  pup1.cell.attr %>% 
  group_by(cell.id) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(cell.id %in% multiple.pup1$cell.id , mean(rfp.mean.bg.sub.puncta), rfp.mean.bg.sub.puncta )) %>% 
    distinct(cell.id, .keep_all = TRUE) 
```

#protein inhibition experiment
proteasome inhibition experiments
```{r}
protInhi.attr <- read_csv("../../../data/all_mg135_attr.csv") %>% 
  rename("cell.id" = "unique.trackID") %>% 
  filter(timepoint == 1) %>% 
  mutate(cell.id = paste0(cell.id ,"_",degron,"_",red,"_",treatment)) %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

multiple.proInh <- protInhi.attr %>% 
  mutate(dapi.mean.bg.sub.puncta = ifelse(is.na(dapi.mean.bg.sub.puncta), 0, dapi.mean.bg.sub.puncta) , 
         rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0 , rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0) %>% 
  group_by(cell.id) %>% 
  tally() %>% 
  filter(n>1)

protInhi.attr <- protInhi.attr %>% 
  group_by(cell.id) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(cell.id %in% multiple.proInh$cell.id , mean(rfp.mean.bg.sub.puncta), rfp.mean.bg.sub.puncta),
         rfp.sum.bg.sub.puncta = ifelse(cell.id %in% multiple.proInh$cell.id, sum(rfp.mean.bg.sub.puncta), rfp.sum.bg.sub.puncta)) %>% 
    distinct(cell.id, .keep_all = TRUE)  
  

```

##Adding the protein inhibition experiment data
```{r}
pup1.proInhi.attr <- pup1.cell.attr %>% 
  bind_rows(.,protInhi.attr %>% 
              dplyr::select(-time, 
                            -timepoint,
                            -image.no, 
                            -ln.gfp, 
                            -ln.gfp.dif,
                            -trackID,
                            -gfp.intensity.center,
                            -gfp.int.mean,
                            -gfp.int.median,
                           -gfp.int.sum,
                           -no.of.triangles,
                           -field,
                           -time.dif.gfp,
                           -real.time.gfp,
                           -sample,
                           -avg.gfp.bg,
                           -Min_gfp,
                           -gfp.mean.bg.sub,
                           -value,
                           -t80,
                           -t95,
                           -threshold,
                           -threshold_95,
                           -gfp.mean.bg.af.sub,
                           -threshold_80,
                           -Mean_gfp,
                           -image,
                           -experiment,
                           -gfp.sum.bg.sub))
```

##ggrides
###with 1uM, 2.5uM and 5uM MG132
```{r}
ggRigd.PrtIng <- all.exp.list %>% 
  filter(red == "pup1-rfp") %>% 
  filter(!(treatment %in% c("none","dmso1","50uM"))) %>% 
  left_join(.,pup1.proInhi.attr , by = c("cell.id","degron","red", "treatment","exp.field")) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0, rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0, image.no < 32) %>%
  filter(!(treatment == "50uM" & image.no == 3)) %>% 
  mutate(degron = case_when(degron == "mODC"  ~ "yeGFP-mODC"),
         treatment = case_when(treatment %in% c("dmso1","dmso2") ~ "DMSO",
                            TRUE ~ treatment),
         treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM"))) %>% 
  group_by(cell.id) %>% 
  mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  filter(image.no > 1) %>% 
  ggplot(.,aes(x = I0_It, y = factor(image.no, levels = c(31:2)) ,fill = treatment, color = treatment))+
  stat_density_ridges(geom = "density_ridges_gradient" , 
                      quantiles = 2, 
                      quantile_lines = TRUE , 
                      aes(height = ..ndensity..), 
                      rel_min_height = 0.01, 
                      size = 0.2) +
  scale_fill_manual(values = alpha(c("indianred2","lightskyblue2","dodgerblue", "royalblue2"), 0.8), name = NULL)+
  scale_color_manual(values = c("indianred4","lightskyblue4","dodgerblue4","royalblue4"), name = NULL)+
  theme_ridges(line_size = 0.3)+
  theme_pubr()+
  theme(text = element_text(size = 6), 
        legend.background = element_blank(),
        legend.direction = "horizontal",
        legend.position = c(0.3,factor(2, levels = 2)),
        legend.key.size = unit(2 ,"mm"),
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2))+
  # scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  ylab("Time")+
  # xlab()+
  # xlim(0,1.1)+
  scale_x_continuous(breaks = seq(0,1,by = 0.25), name = "Normalized GFP Mean Intensity [A.U]", limits = c(-0.1,1.1)) 

ggRigd.PrtIng
```

```{r}
ggsave(plot = ggRigd.PrtIng, path = "~/plots/paper1/figures/", filename = "ggRidg_prtInh.png", width = 2.5, height = 4)
ggsave(plot = ggRigd.PrtIng, path = "~/plots/paper1/figures/", filename = "ggRidg_prtInh.pdf", width = 2.5, height = 4)
```

###with 50uM
```{r}
ggRigd.PrtIng.2 <- all.exp.list %>% 
  filter(red == "pup1-rfp") %>% 
  filter(treatment %in% c("dmso1","50uM")) %>% 
  left_join(.,pup1.proInhi.attr , by = c("cell.id","degron","red", "treatment","exp.field")) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0, rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0, image.no < 32) %>%
  filter(!(treatment == "50uM" & image.no == 3)) %>% 
  mutate(degron = case_when(degron == "mODC"  ~ "yeGFP-mODC"),
         treatment = case_when(treatment %in% c("dmso1","dmso2") ~ "DMSO",
                            TRUE ~ treatment),
         treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM"))) %>% 
  group_by(cell.id) %>% 
  mutate(I0_It = gfpMeanBgAFsub/gfpMeanBgAFsub[1]) %>% 
  filter(image.no > 1) %>% 
  ggplot(.,aes(x = I0_It, y = factor(image.no, levels = c(31:2)) ,fill = treatment, color = treatment))+
  stat_density_ridges(geom = "density_ridges_gradient" , 
                      quantiles = 2, 
                      quantile_lines = TRUE , 
                      aes(height = ..ndensity..), 
                      rel_min_height = 0.01, 
                      size = 0.2) +
  scale_fill_manual(values = alpha(c("indianred2","royalblue2"), 0.8), name = NULL)+
  scale_color_manual(values = c("indianred4","royalblue4"), name = NULL)+
  theme_ridges(line_size = 0.3)+
  theme_pubr()+
  theme(text = element_text(size = 6), 
        legend.background = element_blank(),
        legend.direction = "horizontal",
        legend.position = c(0.3,factor(2, levels = 2)),
        legend.key.size = unit(2 ,"mm"),
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2))+
  # scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  ylab("Time")+
  # xlab()+
  # xlim(0,1.1)+
  scale_x_continuous(breaks = seq(0,1,by = 0.25), name = "Normalized GFP Mean Intensity [A.U]", limits = c(-0.1,1.1)) 

ggRigd.PrtIng.2
```


```{r}
ggsave(plot = ggRigd.PrtIng.2, path = "~/plots/paper1/figures/", filename = "ggRidg_prtInh_50uM.png", width = 2.5, height = 4)
ggsave(plot = ggRigd.PrtIng.2, path = "~/plots/paper1/figures/", filename = "ggRidg_prtInh_50uM.pdf", width = 2.5, height = 4)
```

##half life
```{r}
aic.PrtIn <- aic.df %>% 
  filter(red == "pup1-rfp", treatment != "none") %>% 
  filter(dy > 0.005 & dy < 0.5) %>% 
  group_by(cell.id) %>% 
  filter(model == "dy.dm", dm > 0.000015) %>% 
  left_join(., protInhi.attr, by = c("cell.id","degron","red", "treatment", "exp.field","colony")) 
```

```{r}
unique(aic.PrtIn$degron)
```

##dist of half lives
```{r}
avg.half.prtIn <- aic.PrtIn %>% 
  mutate(degron = case_when(degron %in% c("mODC")  ~ "yeGFP-mODC"),
         treatment = factor(treatment , levels = c("dmso1","dmso2","1uM","2.5uM","5uM","50uM")) ,
         t.half = log(2)/dy, 
         rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 
                                         0, rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta >0) %>% 
  group_by(treatment) %>% 
  summarise(avg.t = median(t.half),
            no.cell = NROW(t.half),
            max.t = max(t.half),
            min.dy = min(dy))

my_comp <- list(c("dmso2","1uM"), c("dmso2","2.5uM"),
                c("dmso2","5uM"),c("1uM","2.5uM"),
                c("1uM","5uM"), c("2.5uM","5uM"))

hl.box.prtIn <-  aic.PrtIn %>% 
  filter(!(treatment %in% c("dmso1","50uM"))) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0, rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0)  %>%
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.2","cln2","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2", "mODC")  ~ "yeGFP-mODC",
                            degron %in% c("stable","stable.2","stable.3") ~ "yeGFP"),
         treatment = case_when(treatment %in% c("dmso1","dmso2") ~ "DMSO", 
                               TRUE ~ treatment),
         treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM")),
         colony = as.numeric(str_remove(string = colony, pattern = "Replicate ")) ,
         colony = factor(colony, levels = c(1:12))) %>% 
  ggplot(.,aes(y = log(2)/dy, x = treatment, fill = treatment))+
  geom_boxplot(outlier.size = 0.2, lwd = 0.1)+
  geom_hline(data = avg.half.prtIn %>% 
               filter(!(treatment %in% c("dmso1","50uM"))) %>% 
               mutate(treatment = case_when(as.character(treatment) %in% c("dmso1","dmso2") ~ "DMSO",
                               TRUE ~ as.character(treatment)),
                      treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM"))) %>% 
               rename("Median"="treatment"), 
             aes(yintercept = avg.t, linetype = Median), 
             size = 0.2)+
  theme_pubr()+
  scale_fill_manual(values = alpha(c("indianred2","lightskyblue2","dodgerblue", "royalblue2"), 0.8), name = NULL)+
  ylab("Half-life [Min.]")+
  theme(axis.title.x = element_blank(), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        text = element_text(size = 6), 
        legend.position = c(0.2,0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(3 ,"mm"),
        legend.spacing.y = unit(-0.25, "cm"))+
  stat_compare_means(method = "t.test", size =2)

hl.box.prtIn
```

```{r}
aic.PrtIn %>% 
  filter(!(treatment %in% c("dmso1","50uM"))) %>% 
  mutate(rfp.mean.bg.sub.puncta = ifelse(is.na(rfp.mean.bg.sub.puncta), 0, rfp.mean.bg.sub.puncta)) %>% 
  filter(rfp.mean.bg.sub.puncta > 0)  %>%
  mutate(degron = case_when(degron %in% c("cln2.3","cln2.2","cln2","cln2.4") ~ "yeGFP-CLN2",
                            degron %in% c("mODC.2", "mODC")  ~ "yeGFP-mODC",
                            degron %in% c("stable","stable.2","stable.3") ~ "yeGFP"),
         treatment = case_when(treatment %in% c("dmso1","dmso2") ~ "DMSO", 
                               TRUE ~ treatment),
         treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM")),
         colony = as.numeric(str_remove(string = colony, pattern = "Replicate ")) ,
         colony = factor(colony, levels = c(1:12))) %>% 
  ggplot(.,aes(y = gfp.mean.bg.af.sub.new, x = treatment, fill = treatment))+
  geom_boxplot(outlier.size = 0.2, lwd = 0.1)+
  # geom_hline(data = avg.half.prtIn %>% 
  #              filter(!(treatment %in% c("dmso1","50uM"))) %>% 
  #              mutate(treatment = case_when(as.character(treatment) %in% c("dmso1","dmso2") ~ "DMSO",
  #                              TRUE ~ as.character(treatment)),
  #                     treatment = factor(treatment , levels = c("DMSO","1uM","2.5uM","5uM","50uM"))) %>% 
  #              rename("Median"="treatment"), 
  #            aes(yintercept = avg.t, linetype = Median), 
  #            size = 0.2)+
  theme_pubr()+
  scale_fill_manual(values = alpha(c("indianred2","lightskyblue2","dodgerblue", "royalblue2"), 0.8), name = NULL)+
  ylab("GFP intensity [A.U]")+
  theme(axis.title.x = element_blank(), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        text = element_text(size = 6), 
        legend.position = c(0.2,0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(3 ,"mm"),
        legend.spacing.y = unit(-0.25, "cm"))+
  stat_compare_means(size = 2)
```

##CV in gfp
```{r}
cv.gfp.PrtIn <- aic.PrtIn %>% 
  group_by(treatment, colony) %>% 
  dplyr::select(dy,gfp.mean.bg.af.sub.new, treatment,colony) %>% 
  na.omit() %>% 
  summarise(gfp.avg = mean(gfp.mean.bg.af.sub.new), 
            gfp.std = sd(gfp.mean.bg.af.sub.new), 
            gfp.max = max(gfp.mean.bg.af.sub.new), 
            gfp.min = min(gfp.mean.bg.af.sub.new), 
            cv.gfp = sd(gfp.mean.bg.af.sub.new)/mean(gfp.mean.bg.af.sub.new), 
            cv2.gfp = (sd(gfp.mean.bg.af.sub.new))^2/mean(gfp.mean.bg.af.sub.new), 
            no.cells = NROW(dy)) %>% 
   mutate_if(is.numeric, ~round(.,digits = 2))
```

##cv in t-half
```{r}
cv.thalf.PrtIn <- aic.PrtIn %>% 
  # filter(ifelse(treatment %in% c("5uM", "2.5uM"), dy > 0.005, dy < 0.5)) %>% 
  dplyr::select(dy,gfp.mean.bg.af.sub.new, treatment, colony) %>% 
  na.omit() %>% 
  ungroup() %>% 
  mutate(t.half = log(2)/dy, 
         colony = as.numeric(str_split(colony, "\ ", simplify = T)[,2])) %>% 
  group_by(treatment, colony) %>% 
  summarise(dy.avg = mean(dy), 
            dy.std = sd(dy), 
            t.half.avg = mean(t.half), 
            t.half.std = sd(t.half) ,
            t.half.max = max(t.half), 
            t.half.min = min(t.half), 
            cv.half = sd(t.half)/mean(t.half), 
            cv2.half = var(t.half)/mean(t.half), 
            no.cells = NROW(dy), 
            range.half = t.half.max/t.half.min) %>% 
   mutate_if(is.numeric, ~round(.,digits = 2))
```

```{r}
log(2)/0.005
```

```{r}
cv.thalf.PrtIn %>% 
  filter(!(treatment %in% c("dmso1","50uM"))) %>% 
  ggplot(.,aes(y = cv.half, 
               x = factor(treatment, levels = c("dmso1","dmso2","1uM","2.5uM","5uM","50uM"))))+
  geom_col(width = 0.2, position = "dodge")+
  # scale_fill_brewer(name = "Replicate", palette = "Set2", guide = "none")+
  # scale_fill_manual(values = alpha(c("indianred2","lightskyblue2","dodgerblue", "royalblue2"), 0.8), name = NULL) +
  ylab("Noise in \nHalf-Lives [C.V]") +
  theme_pubr()+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))+
  theme(axis.title.x = element_blank(), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        text = element_text(size = 6), 
        legend.position = c(0.4,0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(3 ,"mm"),
        legend.spacing.y = unit(-0.25, "cm"))
```


```{r}
cv.gfp.PrtIn %>% 
  ggplot(.,aes(y = cv.gfp, x = factor(treatment, levels = c("dmso1","dmso2","1uM","2.5uM","5uM","50uM"))))+
  geom_col(width = 0.4, position = "dodge")+
  theme_pubr()+
  scale_fill_brewer(name = "Replicate", palette = "Set2", guide = "none")+
  ylab("Noise in \nGFP intensities [C.V]")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))+
  theme(axis.title.x = element_blank(), 
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.2),
        text = element_text(size = 6), 
        legend.position = c(0.4,0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(3 ,"mm"),
        legend.spacing.y = unit(-0.25, "cm"))
```

```{r}
aic.PrtIn %>% 
  dplyr::select(dy,gfp.mean.bg.af.sub.new, treatment, colony) %>% 
  na.omit() %>% 
  ungroup() %>% 
  mutate(t.half = log(2)/dy, 
         colony = as.numeric(str_split(colony, "\ ", simplify = T)[,2])) %>% 
  ggplot(.,aes(x = t.half, fill = treatment))+
  geom_density(alpha = 0.5)+
  theme_pubr()
```



