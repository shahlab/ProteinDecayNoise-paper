---
title: "figure 1"
output: pdf
---
fig1a: methods cartoon
fig1b: model 
fig1c: single cell gfp profile from each GFP


Libraries to load
```{r}
library(data.table)
library(tidyverse)
library(reshape2)
library(gganimate)
library(ggridges)
library(ggpubr)
```

#load the gfp timelapse used for the mechanistic model
```{r}
all.exp.list <- read_csv("~/plots/all_data/all_exp_data.csv")

aic.df <- read_csv("~/plots/all_data/aic.csv")

```


#add the replicate info 
```{r}
aic.df <- aic.df %>% 
  mutate(exp.field = paste0(str_split(cell.id, "_", simplify = T)[,2],"_",
                            str_split(cell.id, "_", simplify = T)[,3]),
    colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8" , "20min_s9") ~ "Replicate 3"))

aic.df <- aic.df %>% 
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony)) %>% 
  filter(value < 0.05)
  

all.exp.list <- all.exp.list %>% 
  mutate(colony = case_when(exp.field %in% c("20min_s3", "20min_s4") ~ "Replicate 1", 
                            exp.field %in% c("20min_s5", "20min_s6") ~ "Replicate 2",
                            exp.field %in% c("20min_s7", "20min_s8") ~ "Replicate 3") ) %>%
  mutate(colony = ifelse(degron == "stable" & red == "pup1-rfp", 
                         case_when(exp.field %in% c("20min_s4", "20min_s5") ~ "Replicate 1",
                                   exp.field %in% c("20min_s6", "20min_s7") ~ "Replicate 2",
                                   exp.field %in% c("20min_s8", "20min_s9") ~ "Replicate 3"), colony))
```

predicted values function
```{r}
dy.dm.f.fn <- function(dy, f, dm, delta.time){
  pred.gfp <- ((dy * (1 - f) * exp(-dy * delta.time)) / dm) + 
              exp(-dy * delta.time) +
              (1 - exp(-dy * delta.time)) * f -
              ((dy * (1 - f) * exp(-(dy + dm) * delta.time)) / dm)
  return(pred.gfp)
}

dy.f.fn <- function(dy,f,delta.time){
  pred.gfp <-  exp(-dy * delta.time) +(1 - exp(-dy * delta.time)) * f
  return(pred.gfp)
}
  
exponential.fn <- function(dy, delta.time){
  pred.gfp <- exp(-dy * delta.time)
  return(pred.gfp)
}
  
dy.dm.fn <- function(dy, dm, delta.time){
  pred.gfp <- ((dy  * exp(-dy * delta.time)) / dm) + exp(-dy * delta.time)  -
              ((dy * 1 * exp(-(dy + dm) * delta.time)) / dm)
  
  return(pred.gfp)
}
```


#df for fig s1a: Pup1-rfp technical replicate 1
To pick random cells from the pup1-rfp replicate 2
```{r}
#to select a cell from each replicate
# aic.df %>% 
#   left_join(.,all.exp.list %>% filter(image.no ==1) %>% select(-delta.time), by = c("cell.id", "red","degron","treatment")) %>% 
#   filter(red == "pup1-rfp", treatment == "none") %>% 
#   filter(degron == "cln2.2") %>% split(.$colony)
```

create a dataframe for plotting the single cell trace
```{r}
figS1a.df <- all.exp.list %>%  
  filter(cell.id %in% c( "1000002041_20min_s4_cln2.2_pup1-rfp_none", 
                         "1000002251_20min_s5_cln2.2_pup1-rfp_none",
                         "1000001819_20min_s8_cln2.2_pup1-rfp_none",
                         
                         "1000001486_20min_s3_mODC_pup1-rfp_none",
                         "1000001296_20min_s6_mODC_pup1-rfp_none",
                         "1000001423_20min_s8_mODC_pup1-rfp_none",
                         
                         "1000001196_20min_s4_stable_pup1-rfp_none",
                         "1000001722_20min_s6_stable_pup1-rfp_none",
                         "1000001360_20min_s8_stable_pup1-rfp_none"
                         )) %>% 
  left_join(.,aic.df, by = c("cell.id","red","degron","treatment","colony"))

figS1a.df %>% split(.$cell.id)

```

get the predicted values for each model for the selected random cells 
```{r}
figS1a.pred <- figS1a.df %>% 
  select(cell.id, delta.time, gfpMeanBgAFsub, degron, f, dy, dm, aic, value,model,colony) %>% 
  group_by(cell.id) %>% 
  mutate(pred.value =  case_when(model == "dy.dm.f" ~ dy.dm.f.fn(dy = dy, 
                                                                dm = dm,
                                                               f = f,
                                                               delta.time = delta.time/60) , 
                               model == "dy.f" ~ dy.f.fn(f = f, 
                                                         dy = dy, 
                                                         delta.time = delta.time/60) , 
                               model == "exponential" ~ exponential.fn(dy = dy, 
                                                                       delta.time = delta.time/60) , 
                               model == "dy.dm" ~ dy.dm.fn(dy = dy, 
                                                           dm = dm, 
                                                           delta.time = delta.time/60)) , 
         pred.gfp = gfpMeanBgAFsub[1]*pred.value)

#changing the levels of the degrons so they appeare in a particular order in facet_grid
figS1a.pred <- figS1a.pred %>% 
  mutate( degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC" ~ "GFP-mODC",
                            degron == "stable" ~ "GFP"), 
          degron = factor(degron, levels = c("GFP-mODC","GFP-CLN2","GFP")))
```

single cell plot
```{r}
figS1a.pred %>% 
  ggplot(.,aes(x = delta.time, y = gfpMeanBgAFsub ))+
  geom_line(color = "gray4")+
  geom_point(size = 1, color = "green4", alpha = 0.2)+
  facet_grid(degron~colony, scales = "free")+
  theme_pubr()+
  xlab("Time (sec)")+
  ylab("GFP Intensity [A.U.]")
  
```

create a dataframe with all the cells info to plot the traces of all the cells 
```{r}
#get the cells that converged for treatment == none and the experiment with cln2.3, modc.2 and stable.2
figS1a.aic.df <- aic.df %>%
  filter(treatment == "none") %>% 
  filter(degron %in% c("mODC", "cln2.2", "stable")  & red == "pup1-rfp") %>% 
  filter(ifelse(degron == "stable", dy < 0.1, dy < 0.5)) %>% 
  distinct(cell.id)


figS1a.allcells.df <- all.exp.list %>% 
  filter(cell.id %in% figS1a.aic.df$cell.id) #only keeping cells that converged
  

figS1a.allcells.df <- figS1a.allcells.df %>% 
  mutate( degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC" ~ "GFP-mODC",
                            degron == "stable" ~ "GFP"),
         degron = factor(degron , levels = c("GFP-mODC","GFP-CLN2","GFP")))


```

all cells GFP trace with a random cell highlighted 

#Fig S1a
```{r}
GFPtrace.pup1Rep2021 <- figS1a.allcells.df %>% 
  # filter(degron == "stable.2") %>% 
  ggplot(.,aes(x = delta.time/60, y = gfpMeanBgAFsub, group = cell.id))+
  geom_line(alpha = 0.5, color = "gray")+
  geom_line(data = figS1a.pred %>% 
              group_by(cell.id) %>% 
              mutate(dm = ifelse(is.na(dm), Inf, dm)) %>% 
              filter(ifelse(degron == "GFP-mODC", model == "dy.dm", model == "exponential")),
            aes(x = delta.time/60, y = pred.gfp),
            color = "black",
            size = 0.5)+
  geom_point(data = figS1a.pred %>% 
              group_by(cell.id) %>% 
               distinct(delta.time, .keep_all = TRUE) ,
             aes(x = delta.time/60, y = gfpMeanBgAFsub),
            color = "green4",
            size = 0.2)+
  facet_grid(degron~colony ,scales = "free_y")+
  theme_pubr()+
  theme(text = element_text(size = 8))+
        # legend.position = c(0.9,0.95) ,
        # legend.background = element_blank(),
        # legend.spacing.y = unit(0.1, "cm") ,
        # legend.key.height = unit(1, "mm"))+
  # guides(fill = guide_legend(byrow = TRUE))+
  xlab("Time [Min.]")+
  ylab("GFP Intensity [A.U]")+
  # scale_color_manual(values = c("green4" , "black") , name = NULL, labels = c("Observed", "Predicted"))
  geom_text(data = figS1a.pred %>% 
              group_by(cell.id) %>% 
              distinct(delta.time, .keep_all = TRUE) %>% 
              filter(delta.time == 0 , 
                     colony == "Replicate 3",
                     degron == "GFP-mODC") %>% 
              slice(rep(1:n(), 2)) %>% 
              mutate(delta.time = c(1100,1200), 
                     gfpMeanBgAFsub =c(600, 500)), 
            label = c("Model" , "Observed"), 
            color = c("black","green4"), 
            size = 2)
  

GFPtrace.pup1Rep2021
  


```



half lives box plot
#fig s1c 
```{r}
pup1RFP.halfLives2021 <- aic.df %>% 
  filter(red == "pup1-rfp", treatment == "none", degron %in% c("cln2.2","mODC", "stable") ) %>% 
  filter(ifelse(degron == "stable", dy < 0.1, dy < 0.5)) %>% 
  group_by(cell.id) %>% 
  filter(ifelse(degron == "mODC", model == "dy.dm", model == "exponential")) %>% 
  mutate(degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC" ~ "GFP-mODC",
                            degron == "stable" ~ "GFP"),
         degron = factor(degron , levels = c("GFP-mODC","GFP-CLN2","GFP"))) %>% 
  # filter(value < 0.05) %>% 
  mutate(dm = ifelse(is.na(dm), Inf, dm)) %>%
  filter(dm > 0.00001) %>%
  ggplot(.,aes(y = log(2)/dy, x = degron, fill = colony))+
  geom_boxplot( outlier.size = 0.5)+
  # geom_jitter(position = position_jitterdodge(jitter.height = 0, jitter.width = 0.1), size = 0.2, alpha = 0.2)+
  theme_pubr()+
  scale_fill_brewer(name = NULL, palette = "Set2")+
  ylab("Half-Life [Min.]")+
  theme(axis.title.x = element_blank(), 
        text = element_text(size = 8), 
        legend.position = c(0.5, 0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(4 ,"mm"))

pup1RFP.halfLives2021
```



#df for fig s1b: Tef2 replicate 1
to select a cell from each replicate
```{r}
# aic.df %>% 
#   left_join(.,all.exp.list %>% filter(image.no ==1) %>% select(-delta.time), by = c("cell.id", "red","degron","treatment")) %>% 
#   filter(red == "tef2-mCherry", treatment == "none") %>% 
#   filter(degron == "cln2.2") %>% 
#   split(.$colony)


```

create a df with random cells 
```{r}
figS1b.df <- all.exp.list %>% 
  filter(cell.id %in% c( "1000001668_20min_s4_cln2.2_tef2-mCherry_none", 
                         "1000001280_20min_s5_cln2.2_tef2-mCherry_none",
                         "1000001605_20min_s7_cln2.2_tef2-mCherry_none",
                         
                         "1000001495_20min_s3_mODC.2_tef2-mCherry_none",
                         "1000001615_20min_s5_mODC.2_tef2-mCherry_none",
                         "1000002021_20min_s7_mODC.2_tef2-mCherry_none"
                         )) %>% 
  left_join(.,aic.df, by = c("cell.id","red","degron","treatment","colony"))

```

get the predicted values for the random cells 
```{r}
figS1b.pred <- figS1b.df %>% 
  select(cell.id, delta.time, gfpMeanBgAFsub, degron, f, dy, dm, aic, model,colony , value) %>% 
  group_by(cell.id) %>% 
  mutate(pred.value =  case_when(model == "dy.dm.f" ~ dy.dm.f.fn(dy = dy, 
                                                                dm = dm,
                                                               f = f,
                                                               delta.time = delta.time/60) , 
                               model == "dy.f" ~ dy.f.fn(f = f, 
                                                         dy = dy, 
                                                         delta.time = delta.time/60) , 
                               model == "exponential" ~ exponential.fn(dy = dy, 
                                                                       delta.time = delta.time/60) , 
                               model == "dy.dm" ~ dy.dm.fn(dy = dy, 
                                                           dm = dm, 
                                                           delta.time = delta.time/60)) , 
         pred.gfp = gfpMeanBgAFsub[1]*pred.value)

#changing the levels of the degrons so they appeare in a particular order in facet_grid
figS1b.pred <- figS1b.pred %>% 
  mutate( degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC.2" ~ "GFP-mODC"), 
          degron = factor(degron, levels = c("GFP-mODC","GFP-CLN2")))
```

single cell plot
```{r}
figS1b.pred %>% 
  ggplot(.,aes(x = delta.time, y = gfpMeanBgAFsub ))+
  geom_line(color = "gray4")+
  geom_point(size = 1, color = "green4", alpha = 0.2)+
  facet_grid(degron~colony, scales = "free")+
  theme_pubr()+
  xlab("Time (sec)")+
  ylab("GFP Intensity [A.U.]")

```


create a df with all the cells trace
```{r}
#get the cells that converged for treatment == none and the experiment with cln2.3, modc.2 and stable.2
figS1b.aic.df <- aic.df %>% 
  group_by(cell.id) %>% 
  filter(aic == min(aic), treatment == "none" & red == "tef2-mCherry") %>% 
  filter(degron %in% c("mODC.2", "cln2.2"))


figS1b.allcells.df <- all.exp.list %>% 
  filter(cell.id %in% figS1b.aic.df$cell.id) #only keeping cells that converged
  

figS1b.allcells.df <- figS1b.allcells.df %>% 
  mutate( degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC.2" ~ "GFP-mODC"),
         degron = factor(degron , levels = c("GFP-mODC","GFP-CLN2")))


```

all cells GFP trace 

#Fig S1b 
```{r}
GFPtrace.tef2Rep2022 <- figS1b.allcells.df %>% 
  # filter(degron == "stable.2") %>% 
  ggplot(.,aes(x = delta.time/60, y = gfpMeanBgAFsub, group = cell.id))+
  geom_line(alpha = 0.5, color = "gray")+
    geom_line(data = figS1b.pred %>% 
              group_by(cell.id) %>% 
              mutate(dm = ifelse(is.na(dm), Inf, dm)) %>% 
              filter(
                ifelse(degron == "GFP-mODC", model == "dy.dm", model == "exponential")),
            aes(x = delta.time/60, y = pred.gfp),
            color = "black",
            size = 0.5)+
  geom_point(data = figS1b.pred %>% 
              group_by(cell.id) %>% 
              distinct(delta.time, .keep_all = TRUE) , aes(x = delta.time/60, y = gfpMeanBgAFsub),
            color = "green4",
            size = 0.2)+
  facet_grid(degron~colony ,scales = "free_y")+
  theme_pubr()+
  theme(text = element_text(size = 8))+
        #  legend.position = c(0.9,0.95) , 
        # legend.background = element_blank(), 
        # legend.spacing.y = unit(0.1, "cm") , 
        # legend.key.height = unit(1, "mm"))+
  guides(fill = guide_legend(byrow = TRUE))+
  xlab("Time [Min.]")+
  ylab("GFP Intensity [A.U]")+
  # scale_color_manual(values = c("green4" , "black") , name = NULL, labels = c("Observed", "Predicted"))
  geom_text(data = figS1b.pred %>% 
              group_by(cell.id) %>% 
              distinct(delta.time, .keep_all = TRUE) %>% 
              filter(delta.time == 0 , 
                     colony == "Replicate 3",
                     degron == "GFP-mODC") %>% 
              slice(rep(1:n(), 2)) %>% 
              mutate(delta.time = c(1100,1200), 
                     gfpMeanBgAFsub =c(2000, 1800)), 
            label = c("Model" , "Observed"), 
            color = c("black","green4"), 
            size = 2)
  

GFPtrace.tef2Rep2022



  
```


#fig s1d: half lives box plot 
```{r}
tef2mCherry.halfLives2022 <- aic.df %>% 
  filter(red == "tef2-mCherry", treatment == "none", degron %in% c("cln2.2","mODC.2")) %>% 
  filter(dy < 0.5) %>% 
  group_by(cell.id) %>% 
  filter(ifelse(degron == "mODC.2", model == "dy.dm", model == "exponential")) %>% 
  mutate(degron = case_when(degron == "cln2.2" ~ "GFP-CLN2",
                            degron == "mODC.2" ~ "GFP-mODC"),
         degron = factor(degron , levels = c("GFP-mODC","GFP-CLN2"))) %>% 
  mutate(dm = ifelse(is.na(dm), Inf, dm)) %>% 
  filter( dm > 0.00001)%>% 
  ggplot(.,aes(y = log(2)/dy, x = degron, fill = colony))+
  geom_boxplot( outlier.size = 0.5)+
  # geom_jitter(position = position_jitterdodge(jitter.height = 0, jitter.width = 0.1), size = 0.2, alpha = 0.2)+
  theme_pubr()+
  scale_fill_brewer(name = NULL, palette = "Set2")+
  ylab("Half-Life [Min.]")+
  theme(axis.title.x = element_blank(), 
        text = element_text(size = 8), 
        legend.position = c(0.5, 0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(4 ,"mm"))

tef2mCherry.halfLives2022
```
```{r}
tef2mCherry.halfLivesAll <- aic.df %>% 
  filter(red == "tef2-mCherry", treatment == "none", 
         degron %in% c("cln2","mODC","cln2.2","mODC.2")) %>% 
  mutate(colony = case_when(degron == "cln2" ~ "Replicate 4",
                            degron == "mODC" ~ "Replicate 4", 
                            TRUE ~ colony)) %>% 
  filter(dy < 0.5) %>% 
  group_by(cell.id) %>% 
  filter( model == "dy.dm") %>% 
  mutate(degron = case_when(degron %in% c("cln2", "cln2.2") ~ "GFP-CLN2",
                            degron %in% c("mODC","mODC.2") ~ "GFP-mODC"),
         degron = factor(degron , levels = c("GFP-mODC","GFP-CLN2"))) %>% 
  mutate(dm = ifelse(is.na(dm), Inf, dm)) %>% 
  filter( dm > 0.00001)%>% 
  ggplot(.,aes(y = log(2)/dy, x = degron, fill = colony))+
  geom_boxplot( outlier.size = 0.5)+
  # geom_jitter(position = position_jitterdodge(jitter.height = 0, jitter.width = 0.1), size = 0.2, alpha = 0.2)+
  theme_pubr()+
  scale_fill_brewer(name = NULL, palette = "Set2")+
  ylab("Half-Life [Min.]")+
  theme(axis.title.x = element_blank(), 
        text = element_text(size = 8), 
        legend.position = c(0.5, 0.9), 
        legend.direction = "horizontal", 
        legend.background = element_blank(), 
        legend.key.size = unit(4 ,"mm"))
tef2mCherry.halfLivesAll
```


```{r}
aic.df %>% 
  filter(red == "tef2-mCherry", treatment == "none", degron %in% c("cln2.2","mODC.2", "mODC.3")) %>% 
  filter(ifelse(degron == "stable.2", dy < 0.1, dy < 0.5)) %>% 
  mutate(dm = ifelse(is.na(dm), Inf, dm)) %>% 
  filter( dm > 0.00001) %>% #removing cells stuck at the boundary of the maturation rate 
  filter(ifelse(degron == "cln2.2", model == "exponential", model == "dy.dm")) %>% 
  mutate(t.half = log(2)/dy) %>% 
  group_by(degron, colony) %>% 
  summarise(dy.avg = mean(dy), 
            dy.std = sd(dy), 
            t.half.avg = median(t.half), 
            t.half.std = sd(t.half) ,
            t.half.max = max(t.half), 
            t.half.min = min(t.half), 
            cv.half = sd(t.half)/mean(t.half), 
            cv2.half = (sd(t.half))^2/mean(t.half)) %>% 
   mutate_if(is.numeric, ~round(.,digits = 2))
```




#final supplemental figure S1 
```{r}
top.sec.s1 <- (GFPtrace.pup1Rep2021 | GFPtrace.tef2Rep2022) 
bottom.sec.s1 <- pup1RFP.halfLives2021 | tef2mCherry.halfLives2022

s1.fig.patch <- (top.sec.s1/bottom.sec.s1)+plot_layout(heights = c(0.5,0.4) , widths = c(0.7,0.3))
s1.fig <- s1.fig.patch + plot_annotation(tag_levels = "A")

s1.fig
```

```{r}
ggsave(plot = s1.fig, path = "~/plots/paper1/figures/fig_1/fig_s1/", filename = "figs1.pdf" , width = 8, height = 5)
ggsave(plot = s1.fig, path = "~/plots/paper1/figures/fig_1/fig_s1/", filename = "figs1.png" , width = 8, height = 5)
```


